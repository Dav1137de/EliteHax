<?php
	include 'db.php';
	include 'validate.php';
	if (!isset($_GET['pwd'])) { exit(); }
	if ($_GET['pwd'] != "HardCodedToChange") { exit(); }
	try {
		//$id = getIdFromToken($db);
		$stmt = $db->prepare("SELECT attacker_id,SUM(upgrades.gpu) as tot_gpu FROM botnet JOIN upgrades ON botnet.defense_id = upgrades.id GROUP BY attacker_id");		
		$stmt->execute();
		
		$arr = $stmt->fetchAll(PDO::FETCH_ASSOC);
		foreach ($arr as $row) {
			$attacker_id = $row['attacker_id'];
			$tot_gpu = $row['tot_gpu']*100;
			$stmt = $db->prepare("UPDATE user SET money=money+? where id=?");
			$stmt->bindValue(1, $tot_gpu, PDO::PARAM_INT);
			$stmt->bindValue(2, $attacker_id, PDO::PARAM_INT);
			$stmt->execute();
		}
		
		$stmt = $db->prepare("UPDATE user SET money=money+10000");		
		$stmt->execute();

		//echo "OK";
		exit();
	} catch(PDOException $ex) {
		echo "An Error occured!\n$ex";
	}
?>
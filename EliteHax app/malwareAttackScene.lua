local widget = require( "widget" )
local composer = require( "composer" )
local json = require ("json")
local myData = require ("mydata")
local upgrades = require("upgradeName")
local malwareAttackScene = composer.newScene()
---------------------------------------------------------------------------------

---------------------------------------------------------------------------------
--> GENERAL FUNCTIONS
---------------------------------------------------------------------------------
local close = function(event)
    composer.hideOverlay( "fade", 400 )
end

---------------------------------------------------------------------------------
--> SCENE EVENTS
---------------------------------------------------------------------------------
--  Scene Creation
function malwareAttackScene:create(event)
    group = self.view
    local params = event.params

    iconSize=fontSize(250)

    myData.malwareRect = display.newRoundedRect( 40, params.top-fontSize(245), display.contentWidth-70, display.actualContentHeight /4+5, 12 )
    myData.malwareRect.anchorX = 0
    myData.malwareRect.anchorY = 0
    myData.malwareRect.strokeWidth = 5
    myData.malwareRect:setFillColor( 0,0,0 )
    myData.malwareRect:setStrokeColor( 0, 0.7, 0 )
    myData.malwareRect.alpha = 1

    -- Money Malware
    myData.moneyMalware = display.newImageRect( "img/malware_money.png",iconSize,iconSize )
    myData.moneyMalware.anchorX = 0
    myData.moneyMalware.anchorY = 0
    myData.moneyMalware.x, myData.moneyMalware.y = iconSize/2 - 40, myData.malwareRect.y+fontSize(130)
    myData.moneyText = display.newText(event.params.moneyChance.."%",myData.moneyMalware.x+40,myData.moneyMalware.y+iconSize ,native.systemFont, fontSize(80))
    myData.moneyText.anchorX = 0
    myData.moneyText.anchorY = 0
    if (event.params.moneyChance == "??") then myData.moneyText:setFillColor( 0.7,0,0 )
    elseif (tonumber(event.params.moneyChance) > 66) then myData.moneyText:setFillColor( 0,0.7,0 ) 
    elseif (tonumber(event.params.moneyChance) > 33) then myData.moneyText:setFillColor( 0.7,0.7,0 ) 
    else myData.moneyText:setFillColor( 0.7,0,0 ) end

    -- Bot Malware
    myData.botMalware = display.newImageRect( "img/malware_botnet.png",iconSize,iconSize )
    myData.botMalware.anchorX = 0
    myData.botMalware.anchorY = 0
    myData.botMalware.x, myData.botMalware.y = myData.moneyMalware.x+iconSize+80, myData.moneyMalware.y
    myData.botText = display.newText(event.params.botChance.."%",myData.botMalware.x+40,myData.botMalware.y+iconSize ,native.systemFont, fontSize(80))
    myData.botText.anchorX = 0
    myData.botText.anchorY = 0
    if (event.params.botChance == "??") then myData.botText:setFillColor( 0.7,0,0 )
    elseif (tonumber(event.params.botChance) > 66) then myData.botText:setFillColor( 0,0.7,0 ) 
    elseif (tonumber(event.params.botChance) > 33) then myData.botText:setFillColor( 0.7,0.7,0 ) 
    else myData.botText:setFillColor( 0.7,0,0 ) end

    -- RAT Malware
    myData.ratMalware = display.newImageRect( "img/malware_rat.png",iconSize,iconSize )
    myData.ratMalware.anchorX = 0
    myData.ratMalware.anchorY = 0
    myData.ratMalware.x, myData.ratMalware.y = myData.botMalware.x+iconSize+80, myData.botMalware.y
    myData.ratText = display.newText(event.params.ratChance.."%",myData.ratMalware.x+40,myData.ratMalware.y+iconSize ,native.systemFont, fontSize(80))
    myData.ratText.anchorX = 0
    myData.ratText.anchorY = 0
    if (event.params.ratChance == "??") then myData.ratText:setFillColor( 0.7,0,0 )
    elseif (tonumber(event.params.ratChance) > 66) then myData.ratText:setFillColor( 0,0.7,0 ) 
    elseif (tonumber(event.params.ratChance) > 33) then myData.ratText:setFillColor( 0.7,0.7,0 ) 
    else myData.ratText:setFillColor( 0.7,0,0 ) end

    -- Close
    myData.closeBtn = display.newImageRect( "img/x.png",iconSize/2.5,iconSize/2.5 )
    myData.closeBtn.anchorX = 1
    myData.closeBtn.anchorY = 0
    myData.closeBtn.x, myData.closeBtn.y = myData.malwareRect.width+20, myData.malwareRect.y+10

    --  Show HUD    
    group:insert(myData.malwareRect)
    group:insert(myData.moneyMalware)
    group:insert(myData.botMalware)
    group:insert(myData.ratMalware)
    group:insert(myData.moneyText)
    group:insert(myData.botText)
    group:insert(myData.ratText)
    group:insert(myData.closeBtn)

    --  Button Listeners
    myData.moneyMalware:addEventListener("tap", event.params.onMoneyClick)
    myData.botMalware:addEventListener("tap", event.params.onBotClick)
    myData.ratMalware:addEventListener("tap", event.params.onRatClick)
    myData.closeBtn:addEventListener("tap", close)

end

-- Home Show
function malwareAttackScene:show(event)
    local taskGroup = self.view
    if event.phase == "will" then
        -- Called when the scene is still off screen (but is about to come on screen).
    end

    if event.phase == "did" then
        --      
    end
end
---------------------------------------------------------------------------------

---------------------------------------------------------------------------------
--> Listener setup
---------------------------------------------------------------------------------
malwareAttackScene:addEventListener( "create", malwareAttackScene )
malwareAttackScene:addEventListener( "show", malwareAttackScene )
---------------------------------------------------------------------------------

return malwareAttackScene